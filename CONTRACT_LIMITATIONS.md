# Contract Limitations

The contract layer introduces several limitations due to the structure of the generated code and strict rules against modification.

## 1. Authentication Context Missing in Service Methods
The generated `server.autogen.kt` files define service interfaces where methods only receive the request body (DTO). They do not receive:
- The `userId` (principal) from the authentication context.
- The `ApplicationCall` object.

**Impact:**
- Authenticated endpoints cannot identify the user performing the action.
- Functions like `Logout`, `DeleteAccount`, `ChangePassword`, `Status`, `MustChangePassword` cannot be implemented securely or correctly because they don't know which user to target.
- `Logout` cannot invalidate the specific token used in the request because the token is not passed to the service method.

**Workaround/Resolution:**
- These methods are currently unimplemented or return errors in the `ContractImpl` classes.
- To fix this, the contract generation must be updated to include `userId: Int` or `principal: UserPrincipal` in the service method signatures for authenticated routes, OR pass the `call` object.
- Alternatively, `ThreadLocal` or `coroutineContext` could be used to pass the user ID implicitly, but this requires additional infrastructure setup in the routing layer which is also autogenerated and "immutable".

## 2. Token Handling in Signup
The contract expects `Signup` to return a `SignupResponseDTO` containing a `bearerToken`.
However, the domain logic requires email verification before issuing a token.
**Impact:** `Signup` returns an empty token or dummy value, and the user must verify their email before logging in separately.

## 3. Autogenerated Routes Function Visibility
The autogenerated route functions (e.g., `authRoutes`) mix public and authenticated routes in a single block or function. Ktor authentication blocks `authenticate(...) { ... }` are used inside, which is good, but since we cannot modify the file to inject the `Principal` extraction logic before calling the service, we are stuck with the service signature limitation mentioned in #1.

## 4. Broken Contract Definitions
The autogenerated contracts contained several errors preventing compilation, which required manual intervention in the "immutable" contracts folder:
- **Missing Class Definitions**: , , ,  were referenced but not defined in . Manually appended them.
- **Type Mismatch in Route Binding**:  route attempted to assign a  (query param) to a  field (). Manually fixed the route parsing logic in .

## 4. Broken Contract Definitions
The autogenerated contracts contained several errors preventing compilation, which required manual intervention in the "immutable" contracts folder:
- **Missing Class Definitions**: `AnswerData`, `CreateQuestionInput`, `Localization`, `UpdateAnswerInput` were referenced but not defined in `questions/dtos.autogen.kt`. Manually appended them.
- **Type Mismatch in Route Binding**: `GetQuestionsBatch` route attempted to assign a `String` (query param) to a `List<Int>` field (`ids`). Manually fixed the route parsing logic in `questions/server.autogen.kt`.
